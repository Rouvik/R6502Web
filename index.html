<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web R6502: The Online 6502 emulator</title>
    
    <!-- Styles -->
    <link rel="stylesheet" href="./styles/memory_container.css">

    <!-- Fonts and Icons -->
    <link rel="stylesheet" href="./styles/materialSymbols.css">
    <link rel="stylesheet" href="./styles/redHatText.css">

    <!-- Base Stylesheet -->
    <link rel="stylesheet" href="./styles/style.css">
    
</head>
<body>
    <h1>R6502 Web: Online 6502 Emulator</h1>
    <div id="editor" style="width: 100vw; height: 30em;">; first 0x600 bytes padding
.org $00
db 0

; code starts from 0x600
.org $600

lda #0
ldx #0

; fill with increasing values of A
loop:
    sta $00, X
    inx
    adc #1  ; add 1 to A (increment)
    jmp loop

; Non maskable interrupt
nmi:
    lda #0
    nmi_loop:
        sta $00, X
        dex
        beq nmp_loop_exit
        jmp nmi_loop

    nmp_loop_exit:
    rti

; Basic interrupt
interrupt:
    lda #9
    ldx #$ff
    irq_loop:
        sta $00, X
        dex
        beq irq_loop_end
        jmp irq_loop
    
    irq_loop_end:
    rti

.org $fffa
dw nmi
dw $600
dw interrupt</div>

    <div class="romDiv">
        <button id="codeCompileBtn" title="Compile assembly and build ROM">Compile and Mount ROM</button>
        <span>OR</span>
        <input type="file" id="programInput" title="Import ROM from external">
    </div> <br>

    <label for="romStartOffset" class="romStartOffset">ROM Start Offset: <input type="text" id="romStartOffset" value="0x00"></label> <br><br>
    <label for="clockInterval" class="romStartOffset">Clock Interval (in ms): <input type="text" id="clockInterval" value="50" min="0"></label> <br><br>

    <div class="ctrlBtnContainer">
        <button id="runBtn" class="materialSymbol ctrlBtn" title="Run the program">&#xe037;</button>
        <button id="stopBtn" class="materialSymbol ctrlBtn" title="Pause execution">&#xe034;</button>
        <button id="clockBtn" class="materialSymbol ctrlBtn" title="Step instruction">&#xf6ff;</button>
        <button id="resetBtn" class="materialSymbol ctrlBtn" title="Reset CPU">&#xe047;</button>
        <button id="irqBtn" class="ctrlBtn" title="Call Interrupt">IRQ</button>
        <button id="nmiBtn" class="ctrlBtn" title="Call Non Maskable Interrupt">NMI</button>
    </div>
    
    <fieldset class="cpuState">
        <legend>CPU Status</legend>
        <textarea id="cpuState" cols="20" rows="4" style="resize: none;" readonly></textarea> <br><br>
        <div><label for="ipVal">IP: </label><input type="text" id="ipVal"></div>
        <div><label for="stackVal">Stack: </label><input type="text" id="stackVal"></div>
        <div><label for="regXVal">X Register: </label><input type="number" id="regXVal"></div>
        <div><label for="regYVal">Y Register: </label><input type="number" id="regYVal"></div>
        <div><label for="regAVal">A Register: </label><input type="number" id="regAVal"></div>
        <div><label for="statusVal">Status Register (<b>NV1B DIZC</b>): </label><input type="text" id="statusVal"></div>
    </fieldset>

    <br>

    <div id="memory-container" class="memory_container"></div>
    <br><br>

    <details class="memCanvas" open>
        <summary>Canvas</summary>
        <canvas id="screen">Oops! Canvas is not available in your browser</canvas> <br>
        <label for="offsetInput" class="romStartOffset">Offset: <input type="text" id="offsetInput"></label> <br><br>
        <label for="dimY" class="romStartOffset">Cols: <input type="number" id="dimY"></label> <br><br>
        <label for="dimX" class="romStartOffset">Rows: <input type="number" id="dimX"></label><br>
    </details>
    <br><br>

    <h1>Help:</h1>
    <details class="docs">
        <summary>Expand</summary>
        <h2>Basic Usage:</h2>
        <h3>Mounting ROM</h3>
        <p>
            6502 compatible ROMs can be introduced in the memory in 3 different ways
            <ul>
                <li>Selecting the ROM from the file input and inserting it</li>
                <li>Writing the assembly in the web editor and compiling it with the compile button</li>
                <li>Directly writing raw bytes in the memory viewer (not recommended)</li>
            </ul>
        </p>
        <h3>How does the emulator work?</h3>
        <p>
            After mounting the ROM you can press the <span class="materialSymbol">&#xe037;</span> button to start the emulation. <br>
            <b><font color="lime">The emulator first finds the reset vector by looking at the address at (0xfffb - 0xfffc) <br>
            and starts emulating from there. You can also manually set the IP in the CPU Status section but it is not recommended.</font></b>
        </p>
        <h3>Interrupt and Reset Vectors</h3>
        <p>
            R6502 is capable to identify and correctly deal with Non Maskable, Reset and Interrupt vectors from their correct locations and work with them. <br>
            The locations are as follows:
            <ul>
                <li>Non Maskable Interrupt Vector = [0xfffa, 0xfffb]</li>
                <li>Reset Vector = [0xfffc, 0xfffd]</li>
                <li>Interrupt Vector = [0xfffe, 0xffff]</li>
            </ul>
            <b><font color="yellow">Care should be taken that these vectors are properly initialised when loading the ROM.</font></b>
        </p>
        <h3>Controls</h3>

        <h4>Rom Start Offset</h4>
        <p>
            Used to set the offset at which to load the ROM, if the ROM is too big and/or the offset makes it go out of bounds
            of <i>0x0000 - 0xffff</i> memory, loading will fail.
        </p>

        <h4>Clock Interval (in ms)</h4>
        <p>
            Used to control clock rate, the lower it is the faster time delay between ticks in ms.
            Zero (0) will give the fastest tick rate (browser / machine dependent).
        </p>

        <h4>Button (<span class="materialSymbol">&#xe037;</span>)</h4>
        <p>
            Start CPU cycling.
        </p>

        <h4>Button (<span class="materialSymbol">&#xe034;</span>)</h4>
        <p>
            Pause CPU cycling. (KEEPS THE CPU STATE INTACT AND CAN BE RESUMED WITH <span class="materialSymbol">&#xe037;</span>)
        </p>

        <h4>Button (<span class="materialSymbol">&#xf6ff;</span>)</h4>
        <p>
            Single step CPU cycles.
        </p>

        <h4>Button (<span class="materialSymbol">&#xe047;</span>)</h4>
        <p>
            Reset CPU state.
        </p>

        <h4>Button (IRQ)</h4>
        <p>
            Trigger an interrupt (obviously respecting the interrupt mask).
        </p>

        <h4>Button (NMI)</h4>
        <p>
            Trigger an non maskable interrupt.
        </p>

        <h4>CPU Status</h4>
        <p>
            Shows all the current CPU status and are modifiable during runtime, extremely handy for debugging. <br><br>
            <b>Status register bits: (NV1B DIZC)</b>
            <ul>
                <li>N - NEG</li>
                <li>V - OVERFLOW</li>
                <li>1 - UNUSED</li>
                <li>B - BRK</li>
                <li>D - DECIMAL(unimplemented)</li>
                <li>I - INTERRUPT_DISABLE</li>
                <li>Z - ZERO</li>
                <li>C - CARRY</li>
            </ul>
        </p>
        <h4>Canvas</h4>
        <p>
            Canvas allows you to get graphics from a section of memory where each location represents a pixel on the canvas <b>Row Major Order</b>. <br>
            The color scheme follows <a href="https://en.wikipedia.org/wiki/File:Xterm_256color_chart.svg">XTERM-256</a> utilising the entire 256 color possibilities from the palette. <br>
            The <b>offset, rows and cols</b> options allow modifying the canvas bounds to th programmers wish to make graphics easier and simpler to implement.
        </p>
    </details>

    <br><br>

    <footer>Created by <b>Rouvik Maji</b> with ❤️ | Emulator by Rouvik Maji <a href="https://github.com/Rouvik/R6502">R6502</a> | Assembler is <a href="https://github.com/parasyte/asm6">asm6 by parasyte</a></footer>
</body>
<script type="module" src="./main.mjs"></script>
<script src="./Toastify.min.js"></script>
<script src="./lib/ace.min.js"></script>
</html>